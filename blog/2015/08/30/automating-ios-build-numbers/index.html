
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Automating iOS build numbers - Adam Speakman</title>
	<meta name="author" content="Adam">

	
	<meta name="description" content="I recently encountered some problems where I was accidentallly duplicating build numbers for our iOS app. At Bridgit we&#8217;re big fans of &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Adam Speakman" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Adam Speakman</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
    <li><a href="/about">About</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
    <li><a href="/about">About</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:adamsp.github.com/speakman-website">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		<a class="google" href="https://plus.google.com/+AdamSpeakman?rel=author" title="Google+">Google+</a>
		
		
		<a class="twitter" href="http://twitter.com/adamsnz" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/adamsp" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:adamsp.github.com/speakman-website">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Automating iOS build numbers</h2>
	<div class="entry-content"><p>I recently encountered some problems where I was accidentallly duplicating build numbers for our iOS app. At <a href="http://gobridgit.com">Bridgit</a> we&#8217;re big fans of automation, so I went about finding a way to avoid this human error and let the machines do the work for me.</p>

<!-- more -->


<p>We use Twitter&#8217;s <a href="http://fabric.io">Fabric</a> platform to distribute our iOS app for internal testing. The &#8220;Beta&#8221; dashboard looks a little like this:</p>

<p><img src="/images/ios-automation/fabric-beta-dashboard.png"></p>

<p>If you aren&#8217;t using this yet, I can&#8217;t recommend it enough - I can distribute a beta build to a select set of testers immediately after archive. I don&#8217;t have to deal with iTunes Connect, and as you can see, I get some great info on that distribution, such as who installed it, who&#8217;s experienced a crash, and more.</p>

<p>As you can see, each build I send out has a build number attached to it - this is set by <code>CFBundleVersion</code> in your app&#8217;s Info.plist file, or alternately by adjusting the value of the &#8220;Build&#8221; field in the &#8220;General&#8221; tab of your app target configuration.</p>

<p>You might also have noticed that some of the builds in that screenshot have the same number. Whoops. Bit difficult to check if someone&#8217;s on the latest version if the build number didn&#8217;t change! At the time, my build process was &#8220;Remember to increment build number, commit changes, press Archive, distribute build&#8221;. You can see how that might fall down - any process that includes &#8220;Remember to X&#8221; is going to fall over eventually.</p>

<h1>Avoiding human error through automation</h1>

<p>To avoid this kind of human error, we now have a handy script we&#8217;ve injected into our build process which automates the process of incrementing the build number.</p>

<figure class='code'><figcaption><span>increment-build-number.sh </span><a href='https://gist.github.com/adamsp/da0e0bab0e25412779ff'>gist</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="nv">$CONFIGURATION</span> <span class="o">==</span> Release <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> -n <span class="k">$(</span>git status --porcelain<span class="k">)</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Repository is dirty, commit your changes.&quot;</span><span class="p">;</span>
</span><span class='line'><span class="nb">exit </span>2
</span><span class='line'><span class="k">fi</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Incrementing build number...&quot;</span>
</span><span class='line'><span class="nv">plist</span><span class="o">=</span><span class="k">${</span><span class="nv">PROJECT_DIR</span><span class="k">}</span>/<span class="k">${</span><span class="nv">INFOPLIST_FILE</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># increment the build number (ie 115 to 116)</span>
</span><span class='line'><span class="nv">buildnum</span><span class="o">=</span><span class="k">$(</span>/usr/libexec/PlistBuddy -c <span class="s2">&quot;Print CFBundleVersion&quot;</span> <span class="s2">&quot;${plist}&quot;</span><span class="k">)</span>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;${buildnum}&quot;</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;No build number in $plist&quot;</span>
</span><span class='line'><span class="nb">exit </span>2
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="nv">buildnum</span><span class="o">=</span><span class="k">$(</span>expr <span class="nv">$buildnum</span> + 1<span class="k">)</span>
</span><span class='line'>/usr/libexec/Plistbuddy -c <span class="s2">&quot;Set CFBundleVersion $buildnum&quot;</span> <span class="s2">&quot;${plist}&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Bumped build number to $buildnum&quot;</span>
</span><span class='line'>
</span><span class='line'>git add <span class="k">${</span><span class="nv">plist</span><span class="k">}</span>
</span><span class='line'>git commit -m <span class="s2">&quot;Increment build number ($buildnum)&quot;</span>
</span><span class='line'>git tag build-<span class="nv">$buildnum</span>
</span><span class='line'>
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="nb">echo</span> <span class="nv">$CONFIGURATION</span> <span class="s2">&quot; build - Not bumping build number.&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>This script does the following:</p>

<ul>
<li>checks to see if the current build is a Release (archive) build

<ul>
<li>if NOT a Release build, do nothing (we don&#8217;t want to increment the build number for every Test or Debug build)</li>
</ul>
</li>
<li>checks to see if <code>git status --porcelain</code> prints anything

<ul>
<li>if something is printed, then the git repository is dirty and we shouldn&#8217;t be doing a build, abort the build</li>
</ul>
</li>
<li>checks for an existing build number

<ul>
<li>if no existing build number, abort the build</li>
</ul>
</li>
<li>increments the build number</li>
<li>commits the build number increment change to git</li>
<li>tags the new commit with the build number so we can easily find it again later</li>
</ul>


<p>Much of this I pieced together from parts of <a href="http://stackoverflow.com/q/9258344/1217087">this StackOverflow question and its answers</a>.</p>

<p>To use this, make sure it&#8217;s executable (<code>chmod +x increment-build-number.sh</code>), then add a new &#8220;Run Script Phase&#8221; to the &#8220;Build Phases&#8221; tab of your target configuration and drop in the path. I left the script at the top level of my project directory so my path is <code>${PROJECT_DIR}/increment-build-number.sh</code>.</p>

<p>To test that it&#8217;s working, make a change, don&#8217;t commit it, and attempt to build an archive - it should fail. Undo your changes, build an archive, and if it succeeds you should see a new tag listed when you run <code>git tag --list</code>.</p>

<h1>Benefits</h1>

<p>Now I can guarantee a new build number for every archive I distribute. Every time a tester reports a problem or I get a crash report, I can confirm which version they&#8217;re running without wondering if it&#8217;s <em>actually</em> the latest build or not. I no longer get submission rejections from the App Store because I forgot to increment the build.</p>

<p>Importantly, I now have git tags for every build - so if a problem shows up, I can easily find the exact place in our git history where it was introduced.</p>

<h1>Caveats</h1>

<p>This script works well as a starter solution, but it has a few caveats. I&#8217;ll address some of these in a future post - however if you&#8217;re the only developer working on a simple application, this example is likely fine to use as-is.</p>

<ul>
<li>build numbers can be duplicated if multiple developers are doing releases</li>
<li>build numbers can be duplicated if releases happen on multiple branches</li>
<li>if the git tag already exists, by the time this fails the commit has already happened and the archive process completes (but applying the tag fails quietly)</li>
<li>fails to consider different schemes and special behaviour you may want for those</li>
<li>doesn&#8217;t push the tag to remote</li>
</ul>


<p>These are all things we can fix (either through process or further automation) - I&#8217;ll go over these fixes in a later post.</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-08-30T13:21:00-04:00" pubdate data-updated="true">Aug 30<span>th</span>, 2015</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/automation/'>automation</a>, <a class='category' href='/blog/categories/ios/'>ios</a>, <a class='category' href='/blog/categories/xcode/'>xcode</a>, <a class='category' href='/blog/categories/xcodebuild/'>xcodebuild</a>


</div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
		
		
		<a class="addthis_button_tweet"></a>
		
		
		<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
		
	</div>
	
	<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
	
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    Adam

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->




	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-34453006-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>